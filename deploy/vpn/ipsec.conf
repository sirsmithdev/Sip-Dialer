# =============================================================================
# strongSwan IPsec Configuration for Digital Ocean â†’ UniFi UDM Pro
# =============================================================================
# This configuration creates a site-to-site VPN tunnel between a Digital Ocean
# droplet and a UniFi UDM Pro router, allowing the dialer engine to communicate
# with the on-premise Grandstream UCM6302 PBX.
#
# IMPORTANT: Replace placeholder values before using:
#   - <DO_DROPLET_PUBLIC_IP>: Your DO droplet's public IP address
#   - <YOUR_HOME_PUBLIC_IP>: Your home/office static public IP
#   - <YOUR_LOCAL_SUBNET>: Your local network (e.g., 192.168.150.0/24)
#
# Installation on Ubuntu 22.04:
#   apt update && apt install -y strongswan strongswan-pki libcharon-extra-plugins
#
# Enable IP forwarding:
#   echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
#   sysctl -p
#
# Start the VPN:
#   systemctl enable strongswan-starter
#   systemctl start strongswan-starter
#   ipsec restart
#
# Check status:
#   ipsec statusall
# =============================================================================

config setup
    # Debug logging (reduce in production)
    charondebug="ike 2, knl 2, cfg 2, net 2, esp 2, dmn 2, mgr 2"
    # Unique IDs for multiple connections
    uniqueids=yes

# =============================================================================
# Connection to UniFi UDM Pro
# =============================================================================
conn unifi-tunnel
    # Connection type
    type=tunnel
    auto=start
    keyexchange=ikev2
    authby=secret

    # ==========================================================================
    # CRITICAL for Digital Ocean: Force UDP encapsulation
    # DO's firewall blocks ESP traffic, so we must encapsulate in UDP
    # ==========================================================================
    forceencaps=yes

    # ==========================================================================
    # Local (Digital Ocean Droplet) Configuration
    # ==========================================================================
    # Use default route to determine local IP
    left=%defaultroute
    # Your DO droplet's public IP (for identification)
    leftid=<DO_DROPLET_PUBLIC_IP>
    # VPN subnet for DO side - devices on DO will use IPs from this range
    leftsubnet=10.10.10.0/24

    # ==========================================================================
    # Remote (UniFi UDM Pro) Configuration
    # ==========================================================================
    # Your home/office static public IP
    right=<YOUR_HOME_PUBLIC_IP>
    rightid=<YOUR_HOME_PUBLIC_IP>
    # Your local network subnet where UCM6302 lives
    # Example: 192.168.150.0/24 (UCM at 192.168.150.10)
    rightsubnet=<YOUR_LOCAL_SUBNET>

    # ==========================================================================
    # Encryption Settings (must match UniFi settings)
    # ==========================================================================
    # IKE Phase 1 - Key Exchange
    ike=aes256-sha256-modp2048!
    # ESP Phase 2 - Data Encryption
    esp=aes256-sha256!

    # ==========================================================================
    # Timeouts and Dead Peer Detection
    # ==========================================================================
    # IKE SA lifetime (28800 seconds = 8 hours, matches UniFi default)
    ikelifetime=28800s
    # ESP SA lifetime (3600 seconds = 1 hour, matches UniFi default)
    lifetime=3600s
    # Dead Peer Detection - restart on failure
    dpdaction=restart
    dpddelay=30s
    dpdtimeout=120s

    # ==========================================================================
    # Fragmentation and MTU
    # ==========================================================================
    fragmentation=yes
